<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Motor 3D - Iluminación Configurable</title>
  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      background: #333;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    canvas { display: block; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-family: monospace;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 100;
    }
    #fps {
      color: #0f0;
      font-weight: bold;
    }
    
    /* Controles móviles */
    .mobile-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 200px;
      pointer-events: none;
      z-index: 50;
    }
    
    /* Joystick */
    #joystick-area {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 150px;
      height: 150px;
      pointer-events: all;
    }
    
    #joystick-base {
      position: absolute;
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    #joystick-stick {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      border: 3px solid rgba(255, 255, 255, 0.8);
      left: 45px;
      top: 45px;
      transition: all 0.1s;
    }
    
    /* Botones de acción */
    #action-buttons {
      position: absolute;
      bottom: 20px;
      right: 20px;
      pointer-events: all;
    }
    
    .action-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: 3px solid rgba(255, 255, 255, 0.5);
      color: white;
      font-size: 24px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px;
      touch-action: none;
      user-select: none;
    }
    
    .action-btn:active {
      background: rgba(255, 255, 255, 0.4);
      transform: scale(0.95);
    }
    
    .action-btn-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* Ocultar en desktop */
  </style>
</head>
<body>
<canvas id="glCanvas" width="960" height="540"></canvas>

<div id="controls">
  <div><span id="fps">FPS: 0</span></div>
  <div><span id="vx">0</span></div>
  <div><span id="vy">0</span></div>
  <div><span id="v">0</span></div>
  <div>Controles: Flechas = mover | W/S = altura</div>
  <div>L = Toggle iluminación | <span id="lightStatus">ON</span></div>
</div>

<!-- Controles móviles -->
<div class="mobile-controls">
  <!-- Joystick -->
  <div id="joystick-area">
    <div id="joystick-base"></div>
    <div id="joystick-stick"></div>
  </div>
  
  <!-- Botones de acción -->
  <div id="action-buttons">
    <div class="action-btn-container">
      <div class="action-btn" id="btn-jump">▲</div>
      <div class="action-btn" id="btn-crouch">▼</div>
    </div>
  </div>
</div>

<script>
// ====== Control de flechas
// ======= CONTROLES =======
const keys = {};
window.addEventListener('keydown', e => {
  keys[e.key] = true;
  
  if (e.key === 'l' || e.key === 'L') {
    ILLUMINATION = !ILLUMINATION;
    document.getElementById('lightStatus').textContent = ILLUMINATION ? 'ON' : 'OFF';
    console.log('Iluminación:', ILLUMINATION ? 'ACTIVADA' : 'DESACTIVADA');
  }
});
window.addEventListener('keyup', e => keys[e.key] = false);

// ====== CONTROLES MÓVILES ======
const joystickArea = document.getElementById('joystick-area');
const joystickStick = document.getElementById('joystick-stick');
const btnJump = document.getElementById('btn-jump');
const btnCrouch = document.getElementById('btn-crouch');

let joystickActive = false;
let joystickStartX = 0;
let joystickStartY = 0;
let joystickX = 0;
let joystickY = 0;

// Joystick touch handlers
joystickArea.addEventListener('touchstart', (e) => {
  e.preventDefault();
  joystickActive = true;
  const touch = e.touches[0];
  const rect = joystickArea.getBoundingClientRect();
  joystickStartX = rect.left + rect.width / 2;
  joystickStartY = rect.top + rect.height / 2;
  updateJoystick(touch.clientX, touch.clientY);
});

joystickArea.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if (joystickActive) {
    const touch = e.touches[0];
    updateJoystick(touch.clientX, touch.clientY);
  }
});

joystickArea.addEventListener('touchend', (e) => {
  e.preventDefault();
  joystickActive = false;
  joystickX = 0;
  joystickY = 0;
  joystickStick.style.left = '45px';
  joystickStick.style.top = '45px';
  // Resetear teclas de dirección
  keys['ArrowLeft'] = false;
  keys['ArrowRight'] = false;
  keys['ArrowUp'] = false;
  keys['ArrowDown'] = false;
});

function updateJoystick(touchX, touchY) {
  const deltaX = touchX - joystickStartX;
  const deltaY = touchY - joystickStartY;
  const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
  const maxDistance = 45; // Radio máximo del joystick
  
  // Limitar la distancia
  const limitedDistance = Math.min(distance, maxDistance);
  const angle = Math.atan2(deltaY, deltaX);
  
  joystickX = Math.cos(angle) * limitedDistance / maxDistance;
  joystickY = Math.sin(angle) * limitedDistance / maxDistance;
  
  // Mover el stick visualmente
  const stickX = 45 + Math.cos(angle) * limitedDistance;
  const stickY = 45 + Math.sin(angle) * limitedDistance;
  joystickStick.style.left = stickX + 'px';
  joystickStick.style.top = stickY + 'px';
  
  // Simular teclas de dirección
  const threshold = 0.3;
  keys['ArrowLeft'] = joystickX < -threshold;
  keys['ArrowRight'] = joystickX > threshold;
  keys['ArrowUp'] = joystickY < -threshold;
  keys['ArrowDown'] = joystickY > threshold;
}

// Botón de salto
btnJump.addEventListener('touchstart', (e) => {
  e.preventDefault();
  keys['w'] = true;
  keys['W'] = true;
});

btnJump.addEventListener('touchend', (e) => {
  e.preventDefault();
  keys['w'] = false;
  keys['W'] = false;
});

// Botón de agacharse
btnCrouch.addEventListener('touchstart', (e) => {
  e.preventDefault();
  keys['s'] = true;
  keys['S'] = true;
});

btnCrouch.addEventListener('touchend', (e) => {
  e.preventDefault();
  keys['s'] = false;
  keys['S'] = false;
});

// Prevenir zoom en dispositivos móviles
document.addEventListener('touchmove', (e) => {
  if (e.scale !== 1) {
    e.preventDefault();
  }
}, { passive: false });

// ======= Configuración =======

let MAX_RENDER_DISTANCE = 50;
let FRUSTUM_MARGIN = 0.4;

let billboard_tiles = [4,3,9,10,11];
let block_tiles = [5,6,7,8];
const billboard_tiles_set = new Set(billboard_tiles);
const block_tiles_set = new Set(block_tiles);

const tile_heights = {
  5: 4,
  7: 8,
  8:10,
  6:10
};
const TILE_SIZE = 32;
const MAP_WIDTH = 100;
const MAP_HEIGHT = 100;
</script>
<script src="image64.js"></script>
<script src="test48.js"></script>
<script src="collision.js"></script>
<script src="glitter7engine.js"></script>
<script src="camera.js"></script>
<script src="player.js"></script>
<script>
 //recursos
 tileMap = TileMaps["test48"].layers[0].data

// Crear el motor
const canvas = document.getElementById('glCanvas');
const engine = new Glitter7engine(canvas, {
  //obligatorio:
  map :{
    array: tileMap,
    mapWidth: 100,
    mapHeight: 100,
  },
  tileSize:32,
  maxRenderDistance: 100,
  
  billboardTiles: [4, 3, 9, 10, 11],
  blockTiles: [5, 6, 7, 8],
  tileHeights: { 5: 4, 7: 8, 8: 10, 6: 10 },
  light:{
    illumination: true,
    ambientLight: 0.5,
    lightDiffuse: 0.7,
    lightDir: [0.3, 0.7, 0.5]
  },
  skydome:{
    enabled:true,
    radius:100,
    segments:12,
    rep_h:1,
    rep_v:7
  },
  fog:{
    enabled:true,
    start:60,
    end:100,
    color: [0.5, 0.5, 0.5]
  }
});

// Cargar recursos
//para desplegar en local, se puede pasar directamente el base 64 a loadSkydome y loadspritesheet
imageToBase64("img/img_cielo.png", (img) => engine.loadSkydomeTexture(img))
imageToBase64("img/tilesheet.png", (img) => engine.loadSpritesheet(img))

let playerObject = { tile: 11, x: 10.5, y: 0.5, z: 0.0 };
// Objetos independientes
const independentObjects = [
  playerObject,
  { tile: 11, x: 10.5, y: 0.5, z: 0.0 },
  { tile: 7, x: 15.0, y: 15.0, z: 0.0 },
  { tile: 4, x: 20.5, y: 20.5, z: 0.0 },
  { tile: 8, x: 25.0, y: 12.0, z: 0.0 }
];
const player = initPlayer(playerObject, tileMap, independentObjects);
applyMovementPreset('REALISTIC');

// Loop de render
function gameLoop() {
  engine.render(independentObjects, true);
  updatePlayer(player, keys);
  updateCamera();
  requestAnimationFrame(gameLoop);
}
gameLoop();

function updateCamera() {
  updatePlayerCamera(engine.camera, player);
}

//función auxiliar para pasar a base64 las imagenes
function imageToBase64(url, callback) {
  const img = new Image();
  img.crossOrigin = "Anonymous"; // necesario si la imagen está en otro dominio
  img.onload = function() {
    const canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    const base64 = canvas.toDataURL("image/png");
    callback(base64);
  };
  img.src = url;
}
</script>
</body>
</html>